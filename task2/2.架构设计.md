# 二、架构设计：Geth 分层架构

## 分层架构图

```plaintext
+-----------------------------------------+
|              应用接口层                  |
|  (RPC/API, Console, Metrics, Dashboard) |
+-----------------------------------------+
|              以太坊协议层                 |
|   (Eth, Les, Miner, TxPool, Accounts)   |
+-----------------------------------------+
|              P2P网络层                   |
|   (Peer, Discovery, Protocols, RLPx)    |
+-----------------------------------------+
|              区块链核心层                 |
|  (Blockchain, State, Headers, Receipts) |
+-----------------------------------------+
|              状态存储层                   |
|      (Trie, Database, Snapshot, Cache)  |
+-----------------------------------------+
|              EVM执行层                   |
|  (VM, Interpreter, Opcodes, GasTable)   |
+-----------------------------------------+
|              基础工具层                   |
|  (Crypto, RLP, Utils, Logging, Metrics) |
+-----------------------------------------+
```

## 各层关键模块解析

### 1. P2P 网络层

**核心包**：go-ethereum/p2p

**关键模块**：
- **Discovery**：基于 Kademlia 算法的节点发现协议，实现节点查找和路由
- **Peer**：管理节点间连接，维护 peer 状态和元数据
- **RLPx**：加密传输协议，提供安全的节点间通信
- **Protocols**：协议注册和消息路由框架，支持多协议并行

**Kademlia 协议实现**：
节点通过`Node`结构体表示，使用`Table`维护路由表，通过ping、findnode、neighbors等消息进行节点发现和网络维护。

### 2. 区块链协议层

**核心包**：go-ethereum/eth

**关键模块**：
- **Eth 协议**：以太坊主协议实现，处理区块同步和交易传播
- **LES（轻节点协议）**：
  - 实现于go-ethereum/les包
  - 为资源受限设备提供轻量级客户端支持
  - 通过 Merkle 证明验证数据，无需存储完整区块链
  - 实现 On-Demand Retrieval 机制按需获取数据
- **TxPool**：交易池管理，负责交易验证、排序和维护
- **Miner**：区块创建和挖矿管理模块

### 3. 状态存储层

**核心包**：go-ethereum/core/state和go-ethereum/trie

**关键模块**：
- **Trie（默克尔树实现）**：
  - 实现 Merkle Patricia Tree 数据结构
  - 支持高效的状态验证和更新
  - 提供快照（Snapshot）功能加速状态查询
  - 核心结构体：Trie、SecureTrie、Database
- **Database**：持久化存储接口，默认使用 LevelDB
- **StateDB**：封装状态操作，提供账户余额、存储等操作接口

### 4. EVM 执行层

**核心包**：go-ethereum/core/vm

**关键模块**：
- **VM**：EVM 核心实现，管理执行环境
- **Opcodes**：EVM 指令集定义，
- **GasTable**：不同以太坊硬分叉的 Gas 消耗表
- **Interpreter**：指令解释器，负责执行 opcode

### 5. 核心数据结构（core/types）

**核心包**：go-ethereum/core/types

**关键结构体**：
```go
// 区块结构
type Block struct {
    header       *Header
    uncles       []*Header
    transactions Transactions
    // 缓存字段...
}

// 交易结构
type Transaction struct {
    data TxData
    // 缓存字段...
}

// 账户状态
type StateAccount struct {
    Nonce    uint64
    Balance  *big.Int
    Root     common.Hash // 存储树根哈希
    CodeHash []byte
}
```
